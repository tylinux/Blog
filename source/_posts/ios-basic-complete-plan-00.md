---
title: iOS基础补完计划（0） - 内存管理
date: 2016-08-31 15:09:47
tags: [basic, iOS]
---

## 概念

在程序开发中，对内存的管理使用是重要的一环，尤其是对于需要长期运行的服务，稍有不甚就可能造成程序运行错误、崩溃，甚至会影响到操作系统的正常运行。在C、C++等“底层”语言中，系统将内存管理全权交给程序员，由程序员决定内存的分配回收。这对程序员的素养提出了更高的要求，能力不达标的极易造成内存泄漏、运行崩溃等问题。在之后的高级语言中，像Java、Python等，把内存管理的权利从程序员手中收回，加入了垃圾收集（GC）机制，自动管理内存，一来减轻程序员负担，再者提高程序稳定性，避免因程序员使用不当造成的内存问题。在手动管理内存与垃圾收集机制之外，还有一种内存管理方式，就是Objective-C语言使用的引用计数（Reference Counting）机制。

### 引用计数

在引用计数的实现中，为每个对象的内存空间增加了一项用于存储对象引用数的字段。每当其他对象引用此对象的时候，对象的引用数加1，当引用的对象被释放或者解除对该对象的引用时，引用数减1。当引用数减为0的时候，该对象即被标记为可释放，随后即被系统回收，重新分配。熟悉Linux系统的同学可能会发现，这种方式与Linux文件系统``硬链接``的概念十分相似，执行``ln``命令可以创建一个硬链接，当执行``rm``或者``unlink``命令时，文件系统会检查link count的值，大于1时link count减1，只有当link count为1时才执行文件删除操作，回收存储空间。根据是否需要程序员手动操作引用计数增减，还可分为手动引用计数（MRC）和自动内存引用（ARC）两种方式。

#### MRC

Objective-C语言中的内存管理功能由Foundation框架提供。在早期的Objective-C中，对象的引用计数需要由程序员手动管理。对象在使用alloc/new/copy/mutableCopy等方法创建出来后，每当需要为对象增加引用计数的时候，程序员需要手动添加``[object retain]``这样的代码。在对象需要减少引用的时候又需要``[object release]``，不便且容易出现内存问题。为了帮助程序员在开发中发现由于管理引用可能出现的内存问题，Apple在自家编译器**Clang**中加入静态代码检查功能，以期在编译时发现引用操作不当的问题。随着Clang静态检查功能的逐渐增强，它已不止可以检查



## iOS内存管理

